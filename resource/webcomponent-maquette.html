<!DOCTYPE html>
<html lang="en-GB" class="noJS" itemscope itemtype="http://schema.org/Article">
<head>
<!-- This website is written by a guy who claims to have lots of specialised technical skills, but this website only partially demonstrates them.  This website is a vehicle for about 240,000 words, please read some of them. -->
<title>WebComponent.mjs</title>
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.06" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Language" content="en-GB" />
<meta name="Author" content="Owen Beresford" />
<meta name="Description" content="A demo / maquette for a browser feature "web components".  A discussion of context to build it, and accessibility ideas, which are often absent from React." />
<meta name="google-site-verification" content="lSgIe7Nm0H0RYQ2ktQ4vr5Jz0iYGhQd7cTWoVDg3Xss" />
<link href="/asset/favicon-32x32.png" rel="icon" type="image/png" />
<meta itemprop="name" content="WebComponent.mjs" />
<meta itemprop="description" content="A demo / maquette for a browser feature "web components".  A discussion of context to build it, and accessibility ideas, which are often absent from React." />
<meta name="twitter:site" content="@channelOwen" />
<meta name="twitter:title" content="WebComponent.mjs" />
<meta name="twitter:description" content="A demo / maquette for a browser feature "web components".  A discussion of context to build it, and accessibility ideas, which are often absent from React." />
<meta name="twitter:creator" content="@channelOwen" />
<meta property="og:title" content="WebComponent.mjs" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://owenberesford.me.uk/resource/webcomponent-maquette" />
<meta property="og:description" content="A demo / maquette for a browser feature "web components".  A discussion of context to build it, and accessibility ideas, which are often absent from React." />
<meta property="og:site_name" content="OwenBeresford's very wordy site" />
<meta property="article:published_time" content="11th of Sep 2025, 18:35:51" />
<meta property="article:modified_time" content="Sep '25" />
<link rel="canonical" href="https://owenberesford.me.uk/resource/webcomponent-maquette" />
<!-- the below track is just a generic cheese track, but the style fits. progressive + uplifting tone.  I do not own the rights or anything. 
TODO: magic tune selection against some index/DB -->
<meta property="og:audio" content="https://www.youtube.com/watch?v=Brl7WmHDG-E" />

<link rel="stylesheet" href="/asset/ob1.min.css" />
<script type="application/ld+json">
  {
    "@context": "https://ogp.me/ns/article#",
    "@type": "Article",
    "name": "WebComponent.mjs",
	"article:published_time":"11th of Sep 2025, 18:35:51", 
    "article:modified_time":"Sep '25",
    "article:section":"technology",

    "author": {
      "@type": "Person",
      "name": "Owen Beresford"
    }
  }
</script>
</head>
<body id="body" class="annoyingBody" data-access="0">
 <div class="h4_page wholeArticle">
  <div class="after_menu articleContent">
   <main id="main">
    <article>
     <div class="blocker popOverWidget">
<div class="halferWords">
<p>Some people think that using a 3rd party framework like React is the best process to build an App.  There are a vast number of libraries available in NPM for React.   Other people, often those doing long term planning, favour the smallest number of libraries and components possible inside software quality.   More loudly for React than other SPA, there will be less security updates if you use less React.  This is just a maquette / demo, to show a realistic amount of code.   Note:</p>

<ul class="ulbasic">
    <li>A React based App can be spammed together very quickly. </li>
    <li>A carefully planned App would use a bigger range of technology, will last longer, run faster, and be easier to update.  The native-browser feature App is likely to consume less power ~ and assuming software updates are installed ~ will run correctly on older phones.</li>
</ul>

<hr />

</div>
<div class="maquetteContainer">
<div class="maquette">
<p>This is a maquette menu, made with a WebComponent.  Includes animation without JS, which is atypical for similar components in NPMJS. <br />BLAH BLAH BLah Blaj bojao fhfhss hsfhsf hg.</p>
<span id="plainHTML"></span>
<skinnable-menu id="fancyHTML" class="errorNoJs" data-flag="4">
<!-- [
{ "type":"a", "id":"attentionHere", "href":"/", "display":"< home", "title":"Look at the article listed on the home page, and my ugly mug."}, 
{ "type":"a", "href":"/resource/search", "display":"Search üîç", "title":"Find an article on this site via the search tool"}, 
{ "type":"a", "href":"/resource/appearance", "display":"Appearance", "title":"Edit the way the site looks, this link includes medical needs planning"}, 
{ "type":"a", "href":"/resource/contact-me", "display":"Contact me üì©", "title":"Send me a message."} 
] --></skinnable-menu>
<p>BLAH BLAH BLah Blaj bojao fhfhss hsfhsf hg</p>
</div>
<div>
<details class="singlePopup withScroll" style="display:block;">
<summary>
<h4 id="toc0">Webcomponent API </h4>
</summary>
<p> Building this was annoying as I can't find a single single doc that shows all the API points for a WebComponent.   All the blogs just mention 3 functions and use words like "complete", "ultimate", "whole lifecycle".   I could read the webrowser source, but that will be a slow process.   Most of the below functions are used in this demo.  To-date, I do not have a use-case for migrating DOM nodes between Documents. </p> 
<code lang="javascript" class="highlight" style="margin-left:3em;">
// #todo look at slots 

class TAGNAME extends HTMLElement {

  static disabledFeatures =[];

  constructor() { }
  
  static get observedAttributes() { return ["THING"] }

  connectedCallback() { } // no param

  disconnectedCallback() { } // no param
  
  attributeChangedCallback(name, oldValue, newValue) { }

  adoptedCallback() { } // don't think any param

}

customElements.whenDefined("TAGNAME").then(()=&gt;{ ACTION(); } );

customElements.define("TAGNAME", TAGNAME);

const SHADOW = thatElement.attachShadow({ mode: 'open' });

// get the shadowDOM for a HTML element if there is one
Node.getRootNode(options)
</code>
</details>
<details class="singlePopup withScroll docs">
<summary>
<h4 id="toc1">Technical Notes </h4>
</summary>
<p>I do not expect to learn very much here for JS.   But knowing what breaks ahead of trying it in a sprint is a good idea.   I will aim to keep all the code in this file if it is still readable.   This is just a demo of the Webcomponent API, not intended a reusable component by itself.  I like this <a href="https://mdn.github.io/web-components-examples/" target="_blank">list of examples</a>.</p>

<p>I have ideas about doing things with a Radial.   I suspect that Golden mean spiral (yes that spiral) will be better and more scalable than an actual circle.   I think it would be nice to add a ‚Äúshake to unspiral‚Äù, like browsers have ‚Äúput phone down should go back‚Äù interaction, and the official Gmap App has ‚Äúshake to report error‚Äù, which unfortunately triggers whilst I am running.   The best washing machine UI is a part mechanical rotating selector, as people can use it in low light, or with poor vision, or impaired coordination.   It is still clear what state the washing machine is in, if there is a power cut, or similar.  #TODO find that UX article again<br />
There are few Radial UI elements in the interwebs, as they do not pack well, and were not practical before 2012.  <br />
If the technique shown here was used at scale, it would lead to smaller SPA.  The information density of the JSON blob to make the menu with is much higher than the flat HTML or worse, a React blob.   To balance the cost of downloading the extra couple of KB of the JS class, the JS class would need to be widely reusable, and include a mature CSS structure.  That exceeds the scope for a demo.  I could make the Component much smaller and simpler if I didn't make it support several render approaches concurrently.</p>

<p>For good #A11y it should be possible to disable more complex rendering modes / styles.  Note the new sub document doesn't automatically import the CSS context of the main page (just like SVG, but here both halves are HTML).  This demo loads work into the CSS engine, as a contrast to most React components.  The displayed structure is using Anchors, as they are links, a different demo may use buttons for features.</p>

<p>The objective of this demo is an inline skinnable UI, where I can change it without the recompile-and-re-upload step.  I'm not sure this is useful outside of branding demos.   However, it is useful for inline support for accessibility.   Current behaviour is :</p>

<ul class="ulbasic">
    <li>load most advanced option</li>
    <li>unless value is over-ridden in the HTML (attr is data-flag)</li>
    <li>unless value is set in URL param (key is 'flag')</li>
    <li>if running on a small screen, display relevant UI (currently it would gain from further CSS, and dedicated interactions).  As this is a maquette, the extra CSS has been left to the reader.</li>
    <li>if browser is setup for no-motion, go to plainer version</li>
    <li>if browser detects shaking, go to plainer version</li>
</ul>


<h5 id="toc0"> V1.2</h5>
<p>I have added an event handler for motion events.  As this demo will be accessible on a HTTPS website, it will execute. <br />
The transition CSS will only execute in Chrome family when there is a focus on the element (logical when you think about the words used).  This is more complex than normal due to the sub-document.<br />
I think I should write v1.3 with plain CSS animation, rather than a transition.</p>


<h5 id="toc1"> Existing work.</h5>
<p>I normally do a trawl of NPMJS to see what exists already with tests.  This maquette is a browser feature, this may be less useful in this case.  However:</p>

<ul class="ulbasic">
    <li>the spec polyfills ~ I assume for very old browsers <a href="https://www.npmjs.com/package/@webcomponents/webcomponentsjs" target="_blank">npm</a> <a href="https://github.com/webcomponents/polyfills" target="_blank">git</a>.   This has a couple of sub projects, for different related features.</li>
    <li><a href="https://lit.dev/" target="_blank">Lit</a> framework <a href="https://lit.dev/docs/" target="_blank">docs</a> <a href="https://github.com/lit/lit" target="_blank">git</a></li>
    <li><a href="https://stenciljs.com/" target="_blank">Stencil</a> framework <a href="https://stenciljs.com/docs/introduction" target="_blank">docs</a> <a href="https://github.com/stenciljs/" target="_blank">git</a></li>
    <li>Useful: a lint plugin <strong>eslint-plugin-wc</strong> <a href="https://www.npmjs.com/package/eslint-plugin-wc" target="_blank">npm</a>.</li>
</ul>

<p>Pls see code sample in the API Popover.  UPDATE <del>Chrome seems to cancel transition animation that is 1s long.  Fixed by being slower.</del><ins>Boundary of problem misdiagnosed.  Chrome doesn't like Transition animation in sub-documents, especially when they may not be on screen / viewport.</ins>   Being shorter worked as I had Devtools open.</p>


<h5 id="toc2"> Reflection</h5>
<ul class="ulbasic">
    <li>Given that I convert the string of HTML to a HTMLIsland of HTML via a TEMPLATE element, I am not sure of the value of this demo.   Using the TEMPLATE is much more concise than issuing DOM calls to set each HTML attribute as a JS instruction.  </li>
    <li>It would be good if I made the CSS more tidy.   For reusable code, I would add its own namespace ~ [now added].</li>
    <li>The mobile view would be more useful if it supported the pull-down to open and swipe to retreat interactions.  Flag=4 will be terrible packing on mobile, <i>don't do that</i>.</li>
    <li>For better readability, I put the data in JSON in a HTML comment.  A more mature solution may use a marked up script similar to [script type=‚Äúapplication/json‚Äù] to hold the data.   See <sup><a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/script#embedding_data_in_html" target="_blank">1</a></sup> existing technology.</li>
    <li>This sample does include more events/ API points than many samples, so is <i>more useful</i>. </li>
    <li>Please note this is a single file maquette, I cannot practically use TS.   I have added API docs.</li>
</ul>


</details>
</div>
</div>
</div>
    </article>
   </main>
	<div id="contentGroup" class="adjacentWidget" data-group="worklog, uitools" title="Use the first link to get the complete range of the group." > <p>Some similar articles in worklog </p>
<div id="groupworklog" class="adjacentList"><a class="adjacentItem button" href="/resource/group-XXX?first=worklog" aria-label="This article lists all items in worklog group.">All of <br />worklog<br /> articles </a> <noscript>Seeing this means the Adjacent feature is <strong>disabled</strong><br /> Try the full page link on the left </noscript></div>
<p>Some similar articles in uitools </p>
<div id="groupuitools" class="adjacentList"><a class="adjacentItem button" href="/resource/group-XXX?first=uitools" aria-label="This article lists all items in uitools group.">All of <br />uitools<br /> articles </a> <noscript>Seeing this means the Adjacent feature is <strong>disabled</strong><br /> Try the full page link on the left </noscript></div>
 </div>

  </div>
  <fieldset class="articleHeader">
	<legend></legend>
	<nav id="navBar" class="row">
			<div class="column">
				<div class="top-bar fullWidth">
					<header><h1>Web Component Maquette</h1></header>
			    	<p role="status" class="bigScreenOnly">    </p>
				</div>
				<div id="shareGroup" class="metaWidget row addReading">
					<span class="SMshareWidget"> 
						<a id="siteChartLink" class="button smallScreenOnly" href="/resource/site-chart" title="open a webpage of what articles this site holds.">Sitemap</a>
						<a id="rssLink" href="https://owenberesford.me.uk/resource/rss" title="Access the sites RSS feed."> <i class="fa fa-rss" aria-label="Open the RSS for this site." aria-hidden="true"></i><span class="sr-only">RSS</span></a> 
						<span class="button smallScreenOnly" id="shareMenuTrigger" rel="nofollow" aria-haspopup="menu" > Share </span>
						<span class="bigScreenOnly">Share: </span>
                        <a href="https://twitter.com/intent/tweet?text=I+think+this+is+important+https%3A%2F%2Fowenberesford.me.uk%2Fresource%2Fwebcomponent-maquette" title="Share this resource on your twitter account." target="_blank" class="bigScreenOnly"> <i class="fa fa-twitter" aria-label="Share this resource on your twitter account." aria-hidden="true"></i><span class="sr-only">Twitter</span></a>
						<a href="#" id="mastoTrigger" class="masto bigScreenOnly" title="Share this article with *your* mastodon instance" aria-haspopup="dialog" >	<i class="fa fa-mastodon" aria-label="Share this article on *your* mastodon instance." aria-hidden="true"></i><span class="sr-only">Mastodon</span> </a>
						<a href="https://www.reddit.com/submit?url=https%3A%2F%2Fowenberesford.me.uk%2Fresource%2Fwebcomponent-maquette" target="_blank" title="Share this article with your Reddit audience" class="bigScreenOnly" ><i aria-label="Share this article with your Reddit audience." class="fa fa-reddit-square" aria-hidden="true"></i><span class="sr-only">Reddit </span> </a>
						<a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fowenberesford.me.uk%2Fresource%2Fwebcomponent-maquette" target="_blank" class="bigScreenOnly" title="Share current article with your linked-in audience." ><i class="fa fa-linkedin-square" aria-hidden="true" aria-label="Share this article with your linked-in audience."></i><span class="sr-only">Linkedin</span> </a>
						<a title="Share current article with Hacker news/ Y combinator audience" target="_blank" class="bigScreenOnly" href="http://news.ycombinator.com/submitlink?u=https%3A%2F%2Fowenberesford.me.uk%2Fresource%2Fwebcomponent-maquette&amp;t=WebComponent.mjs"> <i class="fa fa-hacker-news" aria-label="Share this article with your Y combinator audience." aria-hidden="true"> </i><span class="sr-only">Hacker news</span> </a>
						<a title="Share this article with your Xing audience." href="https://www.xing.com/spi/shares/new?url=https%3A%2F%2Fowenberesford.me.uk%2Fresource%2Fwebcomponent-maquette" target="_blank" class="bigScreenOnly" ><i class="fa fa-xing-square" aria-hidden="true" aria-label="Share this article with your Xing audience."></i><span class="sr-only">Xing</span> </a>
					</span>

					<span class="ultraSkinny bigScreenOnly"> 
						<span>Edited <time title="Page edited on 2025-09-11T18:11:04" datetime="2025-09-11T18:11:04">Sep '25</time>
						</span>
						<span>Created <time datetime="2024-11-16T00:00:00" title="If the value says 03-03-2015; its wrong but that is when this project was moved to the current git project" >Nov '24</time> </span>
					</span>

				</div>
			</div>
			<dialog id="popup" class="mastodonWidget bigScreenOnly">
				<form method="dialog" enctype="multipart/form-data" action="." name="mastoSelection"  >
					<label for="mastodonserver">your server: 
						<input id="mastodonserver" maxlength="50" data-url="https%3A%2F%2Fowenberesford.me.uk%2Fresource%2Fwebcomponent-maquette" type="text" value="" placeholder="mastodon.social" />  
					</label> 
					<span id="sendMasto" class="button masto" title="Share article to *your* mastodon server">Share article now</span>
					<span class="button trimmed" id="hideMasto" title="Close popup"> <i class="fa fa-cancel" aria-hidden="true"></i> Cancel </span>
				</form>
			</dialog>
	
	<div class="bigScreenOnly column linksWidget">
		<details class="linksWidget" id="pageMenu">
			<summary class="defaultLinksTrigger fa-" aria-haspopup="menu"> <span class="sr-only">Menu</span> </summary>

			<menu class="dfl">
			<li>Additional features</li>
<li><a href="/resource/home"><i class="fa fa-angle-left" aria-hidden="true"></i> Home</a> </li> 
<li><a href="/resource/search">Search üîé </a></li>
<li><a href="/resource/appearance">Appearance </a></li>
<li><a href="/resource/contact-me">Contact me üìû </a></li>
<li><a href="#contentGroup">üìú Similar articles</a></li>
			</menu>
		</details>
		<details open class="headingsWidget"><summary class="fa-"><div>Chapters</div></summary><menu class="titleList">
<li><a href="#toc0">Webcomponent API</a></li>
<li><a href="#toc1">Technical Notes</a></li>
</menu>
</details><br />

	</div>
	<!-- /div -->
	</nav>
</fieldset>
 </div> 
 <div id="biblio" style="display:none;">
    <br class="blocker" />
 </div>
 <footer class="row footWidget"> 
	<div class="column leftFooter"> 
		<a href="https://www.plainenglish.co.uk/services" target="_blank" title="They, er, don't have a service for >250,000 word sites, so no logo.">Campaign for Plain English</a><br />
		My profile: <a href="https://www.linkedin.com/in/owen-beresford-bb6ab030/" target="_blank" aria-label="my linked-in" title="Load my linked-in profile" ><i class="fixLinkedSq fa fa-linkedin-square" aria-hidden="true" aria-label="Open my linked in profile" ></i><span class="sr-only">linkedin</span></a> ~ <abbr title="This content wasn't covered in my education, as it didn't exist at that point.">Young tech</abbr>
	</div> 
	<div class="column bigColumn">
		<p> Page rendered <time title="Page rendered on 2025-09-11T18:35:51" datetime="2025-09-11T18:35:51">11th of Sep 2025, 18:35:51</time>, Copyright &copy; 2022 Owen Beresford, <a href="https://owenberesford.me.uk/resource/contact-me">contact me</a>.  Last modified <time title="Page modified on 2025-09-11T18:11:04" datetime="2025-09-11T18:11:04">Sep '25</time>.
	    <p>Read the generous <a rel="license" href="https://owenberesford.me.uk/resource/licence" title="Load the license term; but not that interesting">licence terms</a>, if you feel the need, there is a <a href="https://owenberesford.me.uk/resource/privacy#" title="Load the privacy terms" >privacy here</a>.    View the <a href="https://owenberesford.me.uk/resource/site-chart#" title="Load a page showing all the articles on this site">site map</a>.  <a href="#pageMenu">Jump to menu</a>
	</div>
 </footer>
<script type="module" src="/asset/ob1-202406.min.mjs" ></script>  
<script type="module" >
import { log,  hasBeenRun, currentSize, calcScreenDPI, isLibreWolf, appendIsland } from '/asset/ob1-202406.min.mjs';

/**
SAMPLE USAGE
<skinnable-menu class="errorNoJs" data-flag=2>
<!-- ["< home", "search >", "appearance", "contact-me >"] -->
</skinnable-menu>

<skinnable-menu class="errorNoJs" data-flag=2>
<!-- [
{ type:"a", href="/", display:"< home", title:"look at the article listed on the home page, and my ugly mug."}, 
{ type:"a", href="/resource/search", display:"search üîç", title:"dfgdgd"}, 
{ type:"a", href="/resource/appearance", display:"Appearance", title:"dfgdgd"}, 
{ type:"a", href="/resource/contact-me", display:"Contact me üì©", title:"dfgdgd"}, 
] --></skinnable-menu>
*/

const TEMPLATE1 = [`<div>`, `<div>THING!</div>`, `</div>`];
const TEMPLATE2 = [
  `<div class="wcm1Container"><span id="pageMenu" aria-haspopup="menu"> <i class="fa fa-ob1burger" aria-hidden="true"></i><span class="sr-only">Menu</span> </span> open <menu>`,
  '<li title="${title}"><a href="${href}">${display}</a></li>',
  `</menu></div>`,
];
const TEMPLATE3 = [
  `<div class="wcm1Container"> <details> <summary id="pageMenu" aria-haspopup="menu"><span> <i class="fa fa-ob1burger" aria-hidden="true"></i><span class="sr-only">Menu</span></span> </summary> <menu>`,
  '<li title="${title}"><a href="${href}">${display}</a></li>',
  `</menu> </details></div>`,
];
const TEMPLATE4 = [
  ` <div class="wcm1Container"> <details class="redialMenu"> <summary id="pageMenu" aria-haspopup="menu"><span> ‚öô </span> <span class="sr-only">Menu</span> </summary> <menu>`,
  '<li style="--offset:${offset};" title="${title}"><a href="${href}" id="${id?id:""}">${display}</a></li>',
  `</menu> </details></div `,
];

/**
 * ChangeableMenu
 * A test component, this will be better OO later in life
 
 * @public
 */
class ChangeableMenu extends HTMLElement {
  /////// static consts
  static get WANTED_FIELDS() {
    return ["type", "href", "display", "title", "cssClass", "offset", "id" ];
  }

  ////// private vars
  #mode; // :number
  #children; // :string
  #ourDom; // :ShadowDom
// this is a basic spin lock, or it does unnecessary renders
  #milestone; // :number

  /**
	* constructor
    * the con'tor
 
	* @public
	*/
  constructor() {
    super();
    this.#children = "" + this.innerHTML;
    this.#ourDom = this.attachShadow({ mode: "open" });
	this.#milestone=1;
  }

  /**
   * render
   * Map the values to actual HTML
 
   * @param {Document =document} dom 
   * @param {Location =location} loc 
   * @public
   * @returns {void}
   */
  render(dom = document, loc=location) {
	if(this.#milestone) {
		let struct = dom.createElement("template");
		struct.innerHTML = this.#mergeHTML(
		  this.#setActiveTemplate( this.#mapFlag(loc) ),
		  this.#parseChildren(
			this.#children,
			this.#blob2list,
			this.#map,
			this.#defaultValues,
		  ),
		);
		this.#ourDom.replaceChildren(struct.content);

// I want this section moved outside of render().
// it's adjusting state, BUT where can I put it
		const PARAM=new URLSearchParams(loc.search);
		if(PARAM.has('deploy') && PARAM.get('deploy')==="1" ) {
			this.#deploy(this.#ourDom, '#plainHTML', dom );
			const NO_CHROM=	dom.querySelector( '#fancyHTML' );
			NO_CHROM.setAttribute('data-disabled', '1');
			NO_CHROM.setAttribute('style', "display:none;");
		}

	} else {
		log("warn", "Ran a 'disabled' render (0 elements)");
		this.#ourDom.replaceChildren();	
	}

	log("debug", "Access to shadownDom rendered state (raw)");
	log("debug", dom.querySelector('#fancyHTML' ).shadowRoot.innerHTML);

  }

	/**
     * setActiveTemplate
 	 * [This function go reduced by other code]
     * Internal function to validate the render style
 
     * @param {number} flag
     * @throws Error if the value is invalid
     * @private
     * @returns {string}
     */
  #setActiveTemplate(flag) {
    if ( flag < 1) {
      throw new Error("Unsupported value for RenderMode flag " + flag);
    }
    this.#mode = flag;
    switch (this.#mode) {
      case 1:
        return TEMPLATE1;
      case 2:
        return TEMPLATE2;
      case 3:
        return TEMPLATE3;
      case 4:
        return TEMPLATE4;
      default:
        return TEMPLATE1;
    }
  }

  /**
    * mapFlag
    * Pull value from various places
	* PURE
 
	* @throws - if the located data isn't a valid int.
    * @param {Location} loc - passed in for the search param
    * @private
    * @returns {number}
    */
	#mapFlag( loc) {
		let ret=4;
		if('data-flag' in this.attributes ) {
			ret=parseInt(this.attributes['data-flag'].value, 10);
		}
		let uu=new URLSearchParams(loc.search);
		if(uu.has('flag')) {
			ret=parseInt(uu.get('flag'), 10);
		}
		if(Number.isNaN(ret)) {
			throw new Error("data-flag must be a counting number");
		}
		return ret;
	}

	/**
     * mergeHTML
     * Convert supplied template to actual HTML text
 
     * @param {Array<string>} template
     * @param {Array<object>} children - no interfaces its JS, results of parsing JSON in element middle
     * @private
     * @returns {string}
     */
  #mergeHTML(template, children) {
    let ret = [];
    ret.push(template[0]);
    for (let i in children) {
		children[i].offset=i;
      ret.push(this.#template(template[1], children[i]));
    }
    ret.push(template[3]);
	let assets=`<link rel="stylesheet" href="/asset/ob1.min.css"> 
<style>/* custom CSS for this demo, no planned re-use, so not in main file */ 
 details:has( #pageMenu ) summary::marker { content:""; } 
 details:has( #pageMenu ) summary { padding:0.5em; } 
 details:has( #pageMenu ) { width:20em; } 
 details:has( #pageMenu ) summary>span { padding:0.6em 1em; }
 details[open] { background:var(--scroll1); }
 details[open] menu { border:solid 1px var(--scroll1); background:white; padding-left:0.1em; margin-top:0.2em; } 
 details.redialMenu[open] menu { background:var(--scroll1); } 
 details[open] menu li { margin-left:0.5em; list-style:none; font-size:1.3em; }
 details[open] menu li a { padding:0.3em 1em; display:block; }
 details[open] menu li a:hover { background:yellow; }
 span#pageMenu { margin-right: initial; }

/* CSS to make menu state more clear */
.wcm1Container details:not( [open] ) summary span:has( .fa-ob1burger ):after { content:">>"; font-size:2em; line-height:0.7; position: relative; top: 5px; } 
.wcm1Container details[open] summary span:has( .fa-ob1burger ):before { content:"<<"; font-size:2em; line-height:0.7; margin-bottom:-0.5em; position: relative; top: 5px; } 
.wcm1Container details:not( [open] ) summary span:has( .fa-ob1burger ):before { content:""; } 
.wcm1Container details[open] summary span:has( .fa-ob1burger ):after { content:""; }

/* the redial bit */
@property --offset { 
  syntax: '<number>';
  inherits: false;
  initial-value: 0; 
}	

 .redialMenu { perspective: 1000px; transform-style: preserve-3d; -webkit-transform: perspective(1000px); height: 20em; }
 .redialMenu[open] li { transform-origin: -20% -20%; transform: translateX(100px) rotateZ( calc( var(--offset) * 11deg ) ) translateX(20px); background:white; border-bottom: solid 1px var(--scroll2); transition: transform 1s ease-in; will-change: transition, transform; animation-fill-mode: both; }
/* transition: transform 1s ease-in allow-discrete, overlay 1s allow-discrete; */
 details.redialMenu summary span:nth-child(1) { font-size:2em; font-weight:bold; }

/* localised logo for the menu: a cog */
 details.redialMenu[open] summary span:nth-child(1) { font-size:3em; }
 details.redialMenu[open] summary span:nth-child(1):after { font-size:1em; color:var( --attentionbg ); content:" + "; position:relative; left:-0.95em; }
 details.redialMenu[open] summary span:nth-child(1):before { font-size:1em; color:white; content:" + "; position:relative; top:-0.07em; left:1em; }
 details.redialMenu[open] summary span:nth-child(1) { transition: font-size 1s; } 
 details.redialMenu[open] summary span:nth-child(1):hover { transition: font-size 1s; font-size:2.9em; } 

   </style>`;
    return assets+ret.join("");
  }

  /**
    * template
    * Exec a string template at runtime, just like Python
    * WARN: do not have a variable that is also a JS keyword, or the error is really obscure
 	* TODO add a cache of previously created functions, as it will be the same function 

	* @see [https://stackoverflow.com/a/52818076]
    * @param {string} str
    * @param {Object} vars - the values
    * @private
    * @returns {string}
    */
  #template(str, vars) {
    let func = new Function(...Object.keys(vars), 'return `' + str + '`;');
    return func(...Object.values(vars));
  }

  /**
    * parseChildren
    * A higher level function that coverts a DOM TextNode to a useful array
	* PURE 

    * @param {string} txt - the unparsed text from the middle
    * @param {Function} func1 - this bit would be much better in TS
    * @param {Function} func2
    * @param {Function} func3
	* @throws Error - in case of no JSON
    * @private
    * @returns {Array<Object>}
    */
  #parseChildren(txt, func1, func2, func3) {
    let ret = [];
    let obj = func1(txt);
    if (typeof obj[0] == "object") {
      for (let i in obj) {
        ret.push( func2(obj[i], ChangeableMenu.WANTED_FIELDS, func3( ChangeableMenu.WANTED_FIELDS) ) );
      }
    } else {
      // My code is less functional, as I assume the option of errors
      // and respond appropriately.
      throw new Error("At present, not supporting flat string option.");
    }
    return ret;
  }

  /**
    * blob2list
    * Extract value from DOM TextNode
	* PURE
 
    * @param {string} txt - the text of the TextNode
    * @private
    * @returns {Object} - from JSON.parse
    */
  #blob2list(txt) {
    txt = txt.replace("<!--", "").replace("-->", "");
    txt = txt.trim();

    let obj = JSON.parse(txt);
    if (!Array.isArray(obj) || obj.length == 0) {
      throw new Error("Need an array of options");
    }
    return obj;
  }

  /**
    * map
    * Overwrites initial value with values in first param
	* PURE
 
    * @param {Object} objIn
    * @param {Array<string>} names - fields that are expected
    * @param {Object} initial - object to have same keys as names
    * @private
    * @returns {Object}
    */
  #map(objIn, names, initial) {
    for (let i in names) {
		if( names[i] in objIn ) {
      		initial[names[i]] = objIn[names[i]];
		}
    }
	// #leSigh
	if(! ("id" in objIn)) {
		initial["id"]=null;
	}
    return initial;
  }

  /**
    * deploy 
    * move generated HTML into the original document to see if CSS animation will then work.
	* IMPURE

    * @see [https://stackoverflow.com/questions/20090059/how-to-remove-a-shadow-root-from-an-html-element-adorned-with-a-shadow-dom-from] 
    * @param {ShadowDOM} shadow
    * @param {string} id 
    * @param {Document} dom 
    * @private
    * @returns {void}
    */
	#deploy(shadow, id, dom) {
		const ref=dom.querySelector(id);
		ref.innerHTML="";
		let tmp=shadow.getHTML().split("\n");
		// dump the first line as it imports a CSS file we have in the parent window
		tmp=tmp.slice(1, tmp.length);
		appendIsland(id, tmp.join(" "), dom);
		// no public shadowDOM.close()
	}


  /**
    * defaultValues
    * Convert an array of strings into an object. SHOULD BE IN A LIBRARY
	* PURE
 
    * @param {Array<string>} names
    * @private
    * @returns {Object}
    */
  #defaultValues(names) {
    let out = {};
    for (let k in names) {
      out[ names[k] ] = "";
    }
    return out;
  }

  /**
    * connectedCallback  
    * 
	* IMPURE 
    * @public
    * @returns {void}
    */
  connectedCallback() {
    log("info", "Connected Event");
	if(this.#milestone ===1) {
		this.#milestone++;
    	this.render(document, location);
	}
	document.querySelector('.errorNoJs').classList.remove('errorNoJs');
  }

  /**
    * disconnectedCallback  
    * 
	* PURE 
    * @public
    * @returns {void}
    */
  disconnectedCallback() {
    log("info", "Disconnected Event");
  }

  /**
    * attributeChangedCallback
    * 
	* PURE
 
    * @param {string} naam
    * @param {string} alt
    * @param {string} nu
    * @public
    * @returns {void}
    */
  attributeChangedCallback(naam, alt, nu) {
    log("info", `Attribute ${naam} has changed from ${alt} to ${nu}.`);
    if (naam === "data-flag") {
		this.#milestone++;
    	this.render(document, location);
    }

    if (naam === "data-disabled" && nu) {
		// any true value for nu
		this.#milestone=0;
    }
  }

  /**
    * observedAttributes
    * 
	* PURE
	* @static 
    * @public
    * @returns {Array[string]}
    */
  static get observedAttributes() {
    return ['data-flag', 'data-disabled'];
  }
}

/*
 Class ShakeSensor
   This should be used as a left running an EventEmitter, like mouse code.
   My only local usage has short sampling on page load.

	<strike>Unless I have missed a trick, data binding is finally behaving like normal languages
	https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes/Public_class_fields
	</strike>No I need to for both setInterval and addEventListener

	source https://bhavyakashyap.me/articles?id=js-shake
	alternative https://stackoverflow.com/questions/70544832/detect-shake-event-with-javascript-with-all-major-browsers-devices-ios-androi
*/
class ShakeSensor {
	#x1;
	#y1;
	#z1;
	#x2;
	#y2;
	#z2;
	#sampling;
	#sensitivity;
	#hndl;

  /**
    * constructor
    * 
	* IMPURE
 
    * @param {number} sampling
    * @param {window} win
    * @public
    * @returns {ShakeSensor}
    */
	constructor(sampling=200, win=window) {
		if (typeof win.DeviceMotionEvent == 'undefined') {
			throw new Error("Unsupported JS feature.  This must be run from a HTTPS connection.  Safari may not work either.");
		}
		this.#x1 = this.#y1 = this.#z1 = this.#x2 = this.#y2 = this.#z2 = 0;
		this.#sampling=sampling;
		this.CB=null;

		// leSigh.  The past is still here
		this.doMoving = this.doMoving.bind(this);
		this.evaluate = this.evaluate.bind(this);		
	}

 
  /**
    * startDetectShake 
    * Registers a callback and starts looking for shaking.
    * THIS CODE IS CPU EXPENSIVE
	* IMPURE
 
    * @param {Function} CB
    * @param {number}  sensitivity - Shake sensitivity, a lower number is more sensitive && I infer measured in Pixels.
    * @param {window}  win
    * @public
    * @returns {void}
    */
	startDetectShake(CB, sensitivity=16, win=window) {
		this.#sensitivity =sensitivity;

		win.addEventListener('devicemotion', this.doMoving, false);
		this.#hndl=setInterval(this.evaluate, this.#sampling);
		log("info", "Higher CPU usage for shake detection started");
	}

  /**
    * stopDetectShake 
    * stops looking
	* IMPURE
 
    * @param {window}  win
    * @public
    * @returns {void}
    */
	stopDetectShake(win=window) {
		clearInterval(this.#hndl);
		win.removeEventListener('devicemotion', this.doMoving, false);
		log("info", "Higher CPU usage for shake detection ended");
	}
	

  /**
    * evaluate 
    * Registers a callback and starts looking for shaking.

    * A better design would be to decouple the event logging from motion evaluation.
	* This would allow better knowledge of data that doesn't follow the sample rate.
	* IMPURE
    * @private
    * @returns {void}
    */
	evaluate() {
		let change = Math.abs(this.#x1- this.#x2)+ 
					Math.abs(this.#y1- this.#y2)+ 
					Math.abs(this.#z1- this.#z2);
		if (change > this.#sensitivity) {
			this.CB();
		}
		this.#x2 = this.#x1;
		this.#y2 = this.#y1;
		this.#z2 = this.#z1;
	}

  /**
    * doMoving
    * Registers a callback and starts looking for shaking.
	* IMPURE
 
    * @param {DeviceMotionEvent} e
    * @private
    * @returns {void}
    */
	doMoving(e) {
		this.#x1 = e.accelerationIncludingGravity.x;
		this.#y1 = e.accelerationIncludingGravity.y;
		this.#z1 = e.accelerationIncludingGravity.z;
	}

}


// https://natclark.com/tutorials/javascript-reduced-motion/
// https://stackoverflow.com/questions/7363117/detecting-the-opening-or-closing-of-a-details-element
// https://stackoverflow.com/questions/57813144/how-to-select-element-inside-open-shadow-dom-from-document
function init() {
	window.customElements.define("skinnable-menu", ChangeableMenu);

	const isReduced = (window.matchMedia('(prefers-reduced-motion: reduce)') === true ||
	 window.matchMedia('(prefers-reduced-motion: reduce)').matches === true);
	if(isReduced ) {
		let comp=document.querySelector('#fancyHTML');
		if('data-flag' in comp.attributes && comp.attributes['data-flag'].value >3) {
			comp.setAttribute( 'data-flag', '3');
		}
	}
	if( calcScreenDPI( document, window)>150 ) {
		if(!isLibreWolf(document, window.navigator, window) ) {
			let comp=document.querySelector('#fancyHTML');
			comp.setAttribute( 'data-flag', '2');
		} else if( calcScreenDPI( document, window)>199 ) {
			let comp=document.querySelector('#fancyHTML');
			comp.setAttribute( 'data-flag', '2');
		}
	}

	document.querySelector('#fancyHTML').addEventListener('click', ()=>{ 
		document.querySelector('#fancyHTML').shadowRoot.querySelector('#attentionHere').focus(); 
		}, false);


// lightweight motion detection, only on load, 
// This edition is not adopting permanent service
	const SS1=new ShakeSensor(200, window);  
	const CB=( )=>{ let comp=document.querySelector('#fancyHTML');  comp.setAttribute( 'data-flag', '2'); }
	SS1.startDetectShake(CB, 16, window);

	setTimeout(() => { SS1.stopDetectShake(window); }, 1000);
}

if(hasBeenRun()) {
	init();
} else {
	window.pageStartup=init;
}

</script>
<link rel="stylesheet" href="/asset/hljs.min.css" />
<script type="module" src="/asset/highlight-js.mjs"></script>
<style>
@media screen and (min-width:1560px) {
	.maquetteContainer .maquette { margin-left:5%; margin-top:5%; }
}
.errorNoJs  { height: 12em; display: block; }
.errorNoJs::before { z-index:2; line-height:0.70; position:absolute; border:red 2px solid; content:" üóô "; font-size:8em; padding:0.1em; border-radius:40%; margin-top: 0.3em; margin-left: 0.15em; padding-bottom: 0.25em; pointer-events: none; color:red; }

@media screen and (min-width: 1040px) {
  .popOverWidget .maquetteContainer details.docs[open] { width: calc(100vw - 660px); }
}

</style>
</body>
</html>