<!DOCTYPE html>
<html lang="en-GB" class="noJS" itemscope itemtype="http://schema.org/Article">
<head>
<!-- This website is written by a guy who claims to have lots of specialised technical skills, but this website only partially demonstrates them.  This website is a vehicle for about 240,000 words, please read some of them. -->
<title>PG recipes</title>
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.06" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Language" content="en-GB" />
<meta name="Author" content="Owen Beresford" />
<meta name="Description" content="A thorough analysis of PG and SQL admin recipes.  This group of articles includes Postgres features and tips how to use it optimally.   See related articles for SQL features." />
<meta name="google-site-verification" content="lSgIe7Nm0H0RYQ2ktQ4vr5Jz0iYGhQd7cTWoVDg3Xss" />
<link href="/asset/favicon-32x32.png" rel="icon" type="image/png" />
<meta itemprop="name" content="PG recipes" />
<meta itemprop="description" content="A thorough analysis of PG and SQL admin recipes.  This group of articles includes Postgres features and tips how to use it optimally.   See related articles for SQL features." />
<meta name="twitter:site" content="@channelOwen" />
<meta name="twitter:title" content="PG recipes" />
<meta name="twitter:description" content="A thorough analysis of PG and SQL admin recipes.  This group of articles includes Postgres features and tips how to use it optimally.   See related articles for SQL features." />
<meta name="twitter:creator" content="@channelOwen" />
<meta property="og:title" content="PG recipes" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://owenberesford.me.uk/resource/postgres-recipes" />
<meta property="og:description" content="A thorough analysis of PG and SQL admin recipes.  This group of articles includes Postgres features and tips how to use it optimally.   See related articles for SQL features." />
<meta property="og:site_name" content="OwenBeresford's very wordy site" />
<meta property="article:published_time" content="11th of Dec 2025, 21:20:12" />
<meta property="article:modified_time" content="Dec '25" />
<link rel="canonical" href="https://owenberesford.me.uk/resource/postgres-recipes" />
<!-- the below track is just a generic cheese track, but the style fits. progressive + uplifting tone.  I do not own the rights or anything. 
TODO: magic tune selection against some index/DB -->
<meta property="og:audio" content="https://www.youtube.com/watch?v=Brl7WmHDG-E" />

<link rel="stylesheet" href="/asset/ob1.min.css" />
<script type="application/ld+json">
  {
    "@context": "https://ogp.me/ns/article#",
    "@type": "Article",
    "name": "PG recipes",
	"article:published_time":"11th of Dec 2025, 21:20:12", 
    "article:modified_time":"Dec '25",
    "article:section":"technology",

    "author": {
      "@type": "Person",
      "name": "Owen Beresford"
    }
  }
</script>
</head>
<body id="body" class="annoyingBody" data-access="0">
 <div class="h4_page wholeArticle">
  <div class="after_menu articleContent">
   <main id="main">
    <article>
     <div class="blocker addBashSamples addReferences popOverWidget">
<div class="halferWords">
<p class="buttonBar"> 
This PG text is broken into: 
<a href="/resource/postgres-intro" class="button" title="Text to set context, please read this one first.">Intro</a>
<a href="/resource/postgres-features" class="button" title="A list of the more rare or more recent SQL features that PG supports.  These items can be executed by client code. ">Features</a>
<span href="#" class="button disabled" title="You are here.">Recipes</span>
</p>
</div>
<div class="lotsOfWords">
<ul class="ulbasic">
    <li>For any complete SQL statements in this article, please run on an secondary database first to show it's not locking your system for an unacceptable duration.   If there is a complex equation to project execution cost in advance, I do not have this (would use more than 20 variables).   </li>
    <li>Not really a top secret or innovative, but <b>moving the newest stable edition of open-source tools is widely recommended</b>.  At time of print this is v18, so probably v16 for production ~ loads of webpages referencing ancient versions like PG9, or PG7.  The earliest supported version now is v12.  Also install security updates please, to keep the internet healthy.  </li>
    <li>As dev activity you should be using `EXPLAIN &lt;rest of SQL&gt;` to see why queries are slow, after your DB contains a reasonable amount of data <sup><a href="https://www.postgresql.org/docs/16/using-explain.html#USING-EXPLAIN-BASICS" target="_blank">1</a></sup> <sup><a href="https://www.postgresql.org/docs/16/using-explain.html#USING-EXPLAIN-ANALYZE" target="_blank">2</a></sup>.  For complex statements use `EXPLAIN ANALYSE BUFFERS` for more detailed information.  There exists pg_statistics, but this is less use for queries with multiple columns or indexes (typical) so not recommended.  </li>
    <li>In psql, `\?` will supply available commands ~ this helps with ‚ÄúI need a thingie!&quot; to gain terminology. </li>
    <li>For realistic work, please use PKI certs for authentication (not passwords) <sup><a href="https://www.postgresql.org/docs/16//auth-cert.html" target="_blank">3</a></sup> <sup><a href="https://www.postgresql.org/docs/16//client-authentication.html" target="_blank">4</a></sup>, and have a process to cycle the certs.  Moving authentication away from the developer improves security a large amount, especially with short term contractors.   Most PKI libraries enforce more operational restrictions than a plain-text password does.  </li>
    <li>Unless you are confident the DB and its main clients are isolated together and the rest of the world has no access (strict firewalls), the communication between Postgres and the client (maybe a Django website) should be inside SSL.  Note: this is a separate item. </li>
    <li>In Postgres, DBA can set the disk management rate, via a feature called `VACUUM` <sup><a href="https://www.postgresql.org/docs/current/sql-vacuum.html" target="_blank">5</a></sup> ~ there are config options on this.   In many cases predictable workloads should be managed by `AUTOVACUUM` <sup><a href="https://www.postgresql.org/docs/current/routine-vacuuming.html#AUTOVACUUM" target="_blank">6</a></sup>.   There are edge-cases were a dedicated approach may help <sup><a href="https://www.commandprompt.com/blog/part-2-reproducing-and-diagnosing-autovacuum-failures/" target="_blank">7</a></sup> ~ often temp tables.   On larger data changes (changing disk size of data, not value of data), running `ANALYSE` manually is wise <sup><a href="https://postgres.ai/docs/postgres-howtos/database-administration/maintenance/how-to-run-analyze" target="_blank">8</a></sup>. </li>
    <li>Can load an editor inside psql, `\e` to type SQL with better formatting for readability.   Choose your editor ` \setenv PSQL_EDITOR vim`, or set as a bash variable <sup><a href="https://www.postgresql.org/docs/current/libpq-envars.html" target="_blank">9</a></sup>.  I prefer to use a full separate editor and paste, as that results in SQL text put in the DVCS. </li>
    <li>During development with psql, interactive sessions will probably want `\timing`.  Its common to use `\d+` to describe meta data on the tables.   Similarly `\df+` on functions.  These and more are listed in <sup><a href="https://dev.to/tigerdata/postgresql-cheat-sheet-essential-commands-queries-4eni" target="_blank">10</a></sup>.   To comply to SQL standards, there is also `INFORMATION_SCHEMA` to describe tables. </li>
    <li>If, for some reason, you need to make your PK space larger, it's a headache.   In terms of runtime, it is faster to insert an entirely new column with a default value, as that doesn't move and repack every row.  See <details class="singlePopup withScroll">
<summary>scale a PK cleanly </summary>
<code lang="sql" class="highlight">-- for table ta, adding column pk2, 
-- I have a house style that PKs are named _pk, so less easily confused with FKs which are _id
-- then rename to previous pk
-- This is rewritten from https://postgres.ai/docs/postgres-howtos/schema-design/ddl-operations/how-to-redefine-a-PK-without-downtime
-- not actually tested at all

do $do$
declare
   lock_timeout constant text := '100ms';
   max_attempts constant int := 10;
   ddl_completed boolean := false;
begin

perform set_config('lock_timeout', lock_timeout, false);

alter table ta
	add column pk2 int8 not null default -1;

create unique index concurrently new_unique_index
	on ta using btree( pk2 );

add constraint sniff_test
	check (pk2 is not null) not valid;

alter table your_table
	validate constraint sniff_test;

create unique index concurrently scaledPK
	on ta using btree(pk2);

alter table ta
	add constraint ta_scalable_pk primary key
	using index  new_unique_index;

alter table your_table
drop constraint sniff_test;

ALTER TABLE ONLY ta 
    RENAME COLUMN ta_pk TO old_ta_pk;
-- possibly
-- alter table ta drop column old_ta_pk;

ALTER TABLE ONLY ta 
    RENAME COLUMN pk2 TO  ta_pk;

   if ddl_completed then
      raise info 'DDL successfully executed, run vacuum next';
   else
      raise exception 'DDL execution failed';
   end if;
end $do$;
</code>
</details>, also discussed in <sup><a href="https://www.enterprisedb.com/blog/changes-not-null-postgres-18" target="_blank">11</a></sup> <sup><a href="https://postgres.ai/docs/postgres-howtos/schema-design/ddl-operations/how-to-redefine-a-PK-without-downtime" target="_blank">12</a></sup></li>
    <li>For inline docs, Postgres supports `comment on column ta.field1 is 'This is my field, there are many like it, but this one is mine';` <sup><a href="https://www.postgresql.org/docs/current/sql-comment.html" target="_blank">13</a></sup>.</li>
    <li>The meta information access is mature and well organised ~ all the those tables that start pg_, in v16, there are 65entities.   A list <sup><a href="https://www.postgresql.org/docs/16//catalogs.html" target="_blank">14</a></sup> </li>
    <li> </li>
    <li>Can create Pub/Sub with `LISTEN` and `NOTIFY` <sup><a href="https://www.postgresql.org/docs/current/libpq-notify.html" target="_blank">15</a></sup> <sup><a href="https://www.postgresql.org/docs/current/sql-notify.html" target="_blank">16</a></sup>.</li>
    <li>To have a high availability DB, build locks in auxiliary events carefully.  For example apply `statement_timeout` and `lock table ACCESS EXCLUSIVE MODE` before applying `alter table` commands (or similar) <sup><a href="https://postgresqlco.nf/doc/en/param/statement_timeout/" target="_blank">17</a></sup> <sup><a href="https://www.postgresql.org/docs/16/explicit-locking.html" target="_blank">18</a></sup>.   As these shouldn't be production code, wrap the SQL update script in a bash loop with retry on bad exit code (or Terraform, Jenkins, etc) so if psql can't get a lock it will try again after a delay.   I previously declared a maintenance window in time when the service was normally idle (eg 04:30 to 06:30 on Monday) but this is better.  </li>
    <li>As data needs to be packed into disks, there is better use of space if variable size items are added to the end (MSB data) of the rows ~ discussed in <sup><a href="https://docs.gitlab.com/development/database/ordering_table_columns/" target="_blank">19</a></sup>.   This is important when you have a 100,000,000 rows (eg a couple of months fintech audit data).</li>
    <li>Postgres provides programmatic access to lock's state and activity with `pg_stat_activity` and `pg_locks` <sup><a href="https://www.postgresql.org/docs/current/monitoring-stats.html" target="_blank">20</a></sup> <sup><a href="https://www.postgresql.org/docs/16/view-pg-locks.html" target="_blank">21</a></sup> <sup><a href="https://www.mssqltips.com/sqlservertip/8222/postgresql-monitoring-with-pg-stat-activity-and-pg-locks/" target="_blank">22</a></sup>.   With caution this can be combined with `pg_terminate_backend(@pid)`, but this is risky when run by a human <sup><a href="https://scribe.rip/@jramcloud1/monitoring-active-queries-in-postgresql-real-time-performance-diagnostics-using-pg-stat-activity-cd707a42aee7" target="_blank">23</a></sup>.   I organise a read clone on a different machine for heavy lifting and have never used this solution.   </li>
    <li>There is programmatic access to ‚ÄúPG's version of the FAT table‚Äù, called LSN and WAL values.  Obscure until the day it's needed <sup><a href="https://postgres.ai/docs/postgres-howtos/advanced-topics/misc/lsn-values-and-wal-filenames" target="_blank">24</a></sup>.   </li>
    <li>To ‚Äúfast delete‚Äù table contents with well over a million rows, use `TRUNCATE` <sup><a href="https://www.postgresql.org/docs/16/sql-truncate.html" target="_blank">25</a></sup>, not delete.   This has an implicit vacuum effect, which is a bigger gain for other users of the DB.  Ids / sequences can be preserved with `RESTART IDENTITY` (same link).</li>
    <li>Postgres has typeful maths capacity <sup><a href="https://www.postgresql.org/docs/current/functions-math.html" target="_blank">26</a></sup> ~ this seems similar to CSS maths.    </li>
    <li>There are versions of unicode/ UTF8, and different versions of Postgres support different ones.  They recently added `unicode_version()` to make this less confusing <sup><a href="https://www.postgresql.org/docs/18/functions-info.html#FUNCTIONS-INFO-VERSION" target="_blank">27</a></sup>.  Please panic about the caveat clauses in <sup><a href="https://postgresql.verite.pro/blog/2025/09/20/unicode-versions.html" target="_blank">28</a></sup>.</li>
    <li>Postgres can supply SQL logging for each statement executed, configurable per table, per user, or per database <sup><a href="https://www.postgresql.org/docs/16/runtime-config-logging.html" target="_blank">29</a></sup>.   I have previously written this in the server-side language to allow ‚Äúdecorators‚Äù like masking passwords and GDPR compliance.     </li>
    <li>As an easy to manage platform, Postgres supports admin tools, like the ability to `pg_reload_conf()` or `pg_rotate_logfile()`  <sup><a href="https://www.postgresql.org/docs/current/functions-admin.html" target="_blank">30</a></sup>.   Values can be inspected with `select current_setting('max_wal_size');` <sup><a href="https://www.postgresql.org/docs/current/functions-admin.html#FUNCTIONS-ADMIN-SET" target="_blank">31</a></sup>.</li>
    <li>There is a data validation feature `data_checksum` <sup><a href="https://www.postgresql.org/docs/16/checksums.html" target="_blank">32</a></sup> that knows if data has been corrupted.  This is enable by default.  The best way to look the checksum is whilst offline `pg_checksums -D &lt;pg_data_file&gt; --check  --progress`.   The last param emits info, as this isn't an instant transaction.  The CLI tool can be run again running PG servers.  If your Postgres is a cluster, it will need enabling for each node with `pg_checksums --enable -D &lt;pg_data_file&gt;`</li>
    <li>The best data is available from `pg_stat_statements` <sup><a href="https://www.postgresql.org/docs/current/pgstatstatements.html" target="_blank">33</a></sup>.  This is disabled by default as it is more expensive / computational to build.</li>
    <li>To fill an entire table in 1 statement, use `COPY`, it's simpler and faster <sup><a href="https://www.postgresql.org/docs/16/populate.html#POPULATE-COPY-FROM" target="_blank">34</a></sup>.  The link describes attached settings.  Don't forget to run ANALYZE afterwards to ensure meta data is current.  Data to be copied is normally made by `pg_dump` command.   Remember to check indexes after this step.   </li>
    <li>General management: ensure you have the indexes you need, and no extra ones.  This can be observed inside `pg_stat_user_indexes` <sup><a href="https://www.postgresql.org/docs/16/monitoring-stats.html" target="_blank">35</a></sup> <sup><a href="https://dev-aditya.scribe.rip/understanding-postgresql-views-and-pg-stat-user-indexes-like-a-pro-ba3d5c843bcd" target="_blank">36</a></sup>. </li>
    <li>In some situations, performance can be improved by using pgBouncer <sup><a href="https://www.pgbouncer.org/features.html" target="_blank">37</a></sup>, this acts as a proxy, a session manager, and can alias several PG servers to one logical connection.  Starting and stopping a connection to pgBouncer is cheaper than Postgres itself.   There are multiple connection proxies, but this seems to be the recommended one today.  </li>
    <li>Large tables are more difficult to manipulate as they do not fit in RAM, or the indexes.  Many DB offer sharding, Postgres calls this partitioning <sup><a href="https://www.postgresql.org/docs/16/ddl-partitioning.html" target="_blank">38</a></sup>.  There are several partitioning approaches.  <sup><a href="https://www.postgresql.org/docs/16/ddl-partitioning.html" target="_blank">39</a></sup>  More data on successfully managing the shards <sup><a href="https://www.cybertec-postgresql.com/en/partitioned-table-statistics/" target="_blank">40</a></sup>.</li>
    <li>  </li>
    <li>Tuning for kernel <sup><a href="https://scribe.rip/@jramcloud1/postgresql-17-kernel-tuning-guide-managing-system-parameters-for-optimal-performance-fe097de1dcdb" target="_blank">41</a></sup> <sup><a href="https://www.postgresql.org/docs/current/kernel-resources.html" target="_blank">42</a></sup> and tuning for PG <sup><a href="https://www.mydbops.com/blog/postgresql-parameter-tuning-best-practices" target="_blank">43</a></sup>.</li>
    <li>Newest version of Postgres are using direct I/O, and avoiding O/S features for buffering <sup><a href="https://doxygen.postgresql.org/md_src_backend_storage_aio_README.html" target="_blank">44</a></sup>.  This probably works better with Cloud devices, and the PG team claim higher throughput.</li>
</ul>


</div>
</div>
<style>
.singlePopup summary { border:solid var(--scroll2) 2px; min-width:20em; text-align:center;}
</style>
    </article>
   </main>
	<div id="contentGroup" class="adjacentWidget" data-group="engineering" title="Use the first link to get the complete range of the group." > <p>Some similar articles in engineering </p>
<div id="groupengineering" class="adjacentList"><a class="adjacentItem button" href="/resource/group-XXX?first=engineering" aria-label="This article lists all items in engineering group.">All of <br />engineering<br /> articles </a> <noscript>Seeing this means the Adjacent feature is <strong>disabled</strong><br /> Try the full page link on the left </noscript></div>
 </div>

  </div>
  <fieldset class="articleHeader">
	<legend></legend>
	<nav id="navBar" class="row">
			<div class="column">
				<div class="top-bar fullWidth">
					<header><h1>Postgres Recipes</h1></header>
			    	<p role="status" class="bigScreenOnly">    </p>
				</div>
				<div id="shareGroup" class="metaWidget row addReading">
					<span class="SMshareWidget"> 
						<a id="siteChartLink" class="button smallScreenOnly" href="/resource/site-chart" title="open a webpage of what articles this site holds.">Sitemap</a>
						<a id="rssLink" href="https://owenberesford.me.uk/resource/rss" title="Access the sites RSS feed."> <i class="fa fa-rss" aria-label="Open the RSS for this site." aria-hidden="true"></i><span class="sr-only">RSS</span></a> 
						<span class="button smallScreenOnly" id="shareMenuTrigger" rel="nofollow" aria-haspopup="menu" > Share </span>
						<span class="bigScreenOnly">Share: </span>
                        <a href="https://twitter.com/intent/tweet?text=I+think+this+is+important+https%3A%2F%2Fowenberesford.me.uk%2Fresource%2Fpostgres-recipes" title="Share this resource on your twitter account." target="_blank" class="bigScreenOnly"> <i class="fa fa-twitter" aria-label="Share this resource on your twitter account." aria-hidden="true"></i><span class="sr-only">Twitter</span></a>
						<a href="#" id="mastoTrigger" class="masto bigScreenOnly" title="Share this article with *your* mastodon instance" aria-haspopup="dialog" >	<i class="fa fa-mastodon" aria-label="Share this article on *your* mastodon instance." aria-hidden="true"></i><span class="sr-only">Mastodon</span> </a>
						<a href="https://www.reddit.com/submit?url=https%3A%2F%2Fowenberesford.me.uk%2Fresource%2Fpostgres-recipes" target="_blank" title="Share this article with your Reddit audience" class="bigScreenOnly" ><i aria-label="Share this article with your Reddit audience." class="fa fa-reddit-square" aria-hidden="true"></i><span class="sr-only">Reddit </span> </a>
						<a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fowenberesford.me.uk%2Fresource%2Fpostgres-recipes" target="_blank" class="bigScreenOnly" title="Share current article with your linked-in audience." ><i class="fa fa-linkedin-square" aria-hidden="true" aria-label="Share this article with your linked-in audience."></i><span class="sr-only">Linkedin</span> </a>
						<a title="Share current article with Hacker news/ Y combinator audience" target="_blank" class="bigScreenOnly" href="http://news.ycombinator.com/submitlink?u=https%3A%2F%2Fowenberesford.me.uk%2Fresource%2Fpostgres-recipes&amp;t=PG+recipes"> <i class="fa fa-hacker-news" aria-label="Share this article with your Y combinator audience." aria-hidden="true"> </i><span class="sr-only">Hacker news</span> </a>
						<a title="Share this article with your Xing audience." href="https://www.xing.com/spi/shares/new?url=https%3A%2F%2Fowenberesford.me.uk%2Fresource%2Fpostgres-recipes" target="_blank" class="bigScreenOnly" ><i class="fa fa-xing-square" aria-hidden="true" aria-label="Share this article with your Xing audience."></i><span class="sr-only">Xing</span> </a>
					</span>

					<span class="ultraSkinny bigScreenOnly"> 
						<span>Edited <time title="Page edited on 2025-12-11T11:49:37" datetime="2025-12-11T11:49:37">Dec '25</time>
						</span>
						<span>Created <time datetime="2025-10-05T00:00:00" title="If the value says 03-03-2015; its wrong but that is when this project was moved to the current git project" >Oct '25</time> </span>
					</span>

				</div>
			</div>
			<dialog id="popup" class="mastodonWidget bigScreenOnly">
				<form method="dialog" enctype="multipart/form-data" action="." name="mastoSelection"  >
					<label for="mastodonserver">your server: 
						<input id="mastodonserver" maxlength="50" data-url="https%3A%2F%2Fowenberesford.me.uk%2Fresource%2Fpostgres-recipes" type="text" value="" placeholder="mastodon.social" />  
					</label> 
					<span id="sendMasto" class="button masto" title="Share article to *your* mastodon server">Share article now</span>
					<span class="button trimmed" id="hideMasto" title="Close popup"> <i class="fa fa-cancel" aria-hidden="true"></i> Cancel </span>
				</form>
			</dialog>
	
	<div class="bigScreenOnly column linksWidget">
		<details class="linksWidget" id="pageMenu">
			<summary class="defaultLinksTrigger fa-" aria-haspopup="menu"> <span class="sr-only">Menu</span> </summary>

			<menu class="dfl">
			<li>Additional features</li>
<li><a href="/resource/home"><i class="fa fa-angle-left" aria-hidden="true"></i> Home</a> </li> 
<li><a href="/resource/search">Search üîé </a></li>
<li><a href="/resource/appearance">Appearance </a></li>
<li><a href="/resource/contact-me">Contact me üìû </a></li>
<li><a href="#contentGroup">üìú Similar articles</a></li>
			</menu>
		</details>
		
	</div>
	<!-- /div -->
	</nav>
</fieldset>
 </div> 
 <div id="biblio" style="display:none;">
    <br class="blocker" />
 </div>
 <footer class="row footWidget"> 
	<div class="column leftFooter"> 
		<p>My profile: <a href="https://www.linkedin.com/in/owen-beresford-bb6ab030/" target="_blank" aria-label="my linked-in" title="Load my linked-in profile" ><i class="fixLinkedSq fa fa-linkedin-square" aria-hidden="true" aria-label="Open my linked in profile" ></i><span class="sr-only">linkedin</span></a> ~ <abbr title="This content wasn't covered in my education, as it didn't exist at that point.">Young tech</abbr>
	</div> 
	<div class="column bigColumn">
		<p> Page rendered <time title="Page rendered on 2025-12-11T21:20:12" datetime="2025-12-11T21:20:12">11th of Dec 2025, 21:20:12</time>, Copyright &copy; 2022 Owen Beresford, <a href="https://owenberesford.me.uk/resource/contact-me">contact me</a>.  Last modified <time title="Page modified on 2025-12-11T11:49:37" datetime="2025-12-11T11:49:37">Dec '25</time>.
	    <p>Read the generous <a rel="license" href="https://owenberesford.me.uk/resource/licence" title="Load the license term; but not that interesting">licence terms</a>, if you feel the need, there is a <a href="https://owenberesford.me.uk/resource/privacy#" title="Load the privacy terms" >privacy here</a>.    View the <a href="https://owenberesford.me.uk/resource/site-chart#" title="Load a page showing all the articles on this site">site map</a>.  <a href="#pageMenu">Jump to menu</a>
	</div>
 </footer>
<script type="module" src="/asset/ob1-202406.min.mjs" ></script>  

</body>
</html>